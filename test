# --- Configuration ---
$ApiKey = "AIzaSyDlSa2yLE7b1fv62r6NbrvYnU20nGJWNXo"
# Using the latest efficient model. Change to "gemini-1.5-pro" for higher reasoning.
$Model = "gemini-2.5-flash" 
$Prompt = "Explain the theory of relativity in simple terms."

# --- The Latest API Endpoint (v1beta) ---
# The new SDKs wrap this specific endpoint structure.
$Url = "https://generativelanguage.googleapis.com/v1beta/models/${Model}:generateContent?key=$ApiKey"

# --- Payload Construction ---
# The API strictly requires this nested 'contents' -> 'parts' -> 'text' structure.
$Body = @{
    contents = @(
        @{
            role = "user"
            parts = @(
                @{ text = $Prompt }
            )
        }
    )
    # Optional: New generation config settings available in the latest API
    generationConfig = @{
        temperature = 0.7
        topK = 40
        topP = 0.95
        maxOutputTokens = 1024
    }
} | ConvertTo-Json -Depth 5

# --- Execution ---
try {
    Write-Host "Sending request to $Model..." -ForegroundColor Green
    
    $Response = Invoke-RestMethod -Method Post -Uri $Url -ContentType "application/json" -Body $Body
    
    # --- Parsing the Response ---
    # The response structure contains the generated text inside candidates -> content -> parts
    if ($Response.candidates -and $Response.candidates[0].content.parts) {
        $GeneratedText = $Response.candidates[0].content.parts[0].text
        
        Write-Host "`nGemini Response:" -ForegroundColor Cyan
        Write-Host $GeneratedText
    }
    else {
        Write-Warning "Response received but no text found. Check if the model blocked the query."
        Write-Host ($Response | ConvertTo-Json -Depth 5) -ForegroundColor Gray
    }
}
catch {
    Write-Error "API Request Failed."
    Write-Host "Status Code: $($_.Exception.Response.StatusCode.value__)" -ForegroundColor Red
    
    # Attempt to read detailed error message from Google
    $ErrorStream = $_.Exception.Response.GetResponseStream()
    if ($ErrorStream) {
        $Reader = [System.IO.StreamReader]::new($ErrorStream)
        $ErrorBody = $Reader.ReadToEnd()
        Write-Host "Details: $ErrorBody" -ForegroundColor Yellow
    }
}